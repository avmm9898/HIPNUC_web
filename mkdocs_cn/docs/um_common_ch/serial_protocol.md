

## 串口通讯协议

### 数据包格式

模块上电后，模块默认按100Hz (出厂默认输出速率) 输出数据包，数据包格式如下：

![](common_figures/seral_protocol.png)

其中：

| 域      | 值      | 长度(字节) | 说明                                                         |
| ------- | ------- | ---------- | ------------------------------------------------------------ |
| PRE     | 0x5A    | 1          | 固定为0x5A                                                   |
| TYPE    | 0xA5    | 1          | 固定为0xA5 代表数据帧                                        |
| LEN     | 1-65535 | 2          | 帧中数据域的长度。LSB(低字节在前)，长度表示数据域的长度，不包含`PRE`,`TYPE`,`LEN`,`CRC` 字段。 |
| CRC     | -       | 2          | 除CRC 本身外其余所有帧数据的16 位CRC 校验和。LSB(低字节在前) |
| PAYLOAD | -       | 1-256      | 一帧携带的数据                                               |


CRC实现函数：

```
/*
	currectCrc: previous crc value, set 0 if it's first section
	src: source stream data
	lengthInBytes: length
*/
static void crc16_update(uint16_t *currectCrc, const uint8_t *src, uint32_t lengthInBytes)
{
    uint32_t crc = *currectCrc;
    uint32_t j;
    for (j=0; j < lengthInBytes; ++j)
    {
        uint32_t i;
        uint32_t byte = src[j];
        crc ^= byte << 8;
        for (i = 0; i < 8; ++i)
        {
            uint32_t temp = crc << 1;
            if (crc & 0x8000)
            {
                temp ^= 0x1021;
            }
            crc = temp;
        }
    } 
    *currectCrc = crc;
}
```


* PAYLOAD(数据域): 
	PAYLOAD 由若干个**寄存器数据**组成。每个寄存器数据包含：寄存器地址(REG_ADDR)和寄存器数据(DATA) 两部分。寄存器地址决定了数据的类型及长
度，DATA 为寄存器数据内容。模块支持的寄存器如下:



| 寄存器地址(REG_ADDR) | 寄存器长度(DATA长度, 单位字节) | 名称              | 单位       | 支持该数据包的产品 |
| -------- | ---------- | ----------------- | ---------- | -------- |
| 0x90 | 1 | 用户ID | 无 | HI22X |
| 0xA0     | 6          | 加速度            | 0.001G[^G]  | HI22X |
| 0xA5 | 6 | 线性加速度 | 0.001G | HI22X |
| 0xB0     | 6          | 角速度            | 0.1°/s     | HI22X |
| 0xC0     | 6          | 磁场强度          | 0.001Gauss | HI22X |
| 0xD0     | 6          | 欧拉角 (整形输出) | 度         | HI22X    |
| 0xD9     | 12         | 欧拉角(浮点输出)  | 度         | HI22X    |
| 0xD1     | 16         | 四元数            | N/A      | HI22X |
| 0xF0 | 4 | 气压 | Pa | N/A |
| 0x71 | 128-256字节可变 | 无线节点四元数集合 | 无 | HI221GW(接收机) |
| 0x72 | 48-96字节可变 | 无线节点欧拉角集合 | 同0xD0 | HI221GW(接收机) |
| 0x75 | 48-96字节可变 | 无线节点加速度集合 | 同0xA0 | HI221GW(接收机) |
| 0x78 | 48-96字节可变 | 无线节点角速度集合 | 同0xB0 | HI221GW(接收机) |
| 0x61 | 3 | 无线数据帧拓展标识 | N/A | HI221GW(接收机) |




* 0x90 
	用户ID

* 0xA0
	加速度，格式为int16，共三个轴，每个轴占2 个字节，X、Y、Z 三轴共6 个字节，LSB。传感器输出的原始加速度

* 0xA5
	性加速度，格式为int16，共三个轴，每个轴占2 个字节，X、Y、Z 三轴共6 个字节，LSB。地理坐标系下去除重力分量的加速度值

* 0xB0
	角速度，格式为int16，共三个轴，每个轴占2 个字节，X、Y、Z 三轴共6 个字节，LSB。传感器输出的角速度

* 0xC0
	磁场强度，格式为int16，共三个轴，每个轴占2 个字节，X、Y、Z 三轴共6 个字节，LSB。传感器输出的磁场强度

* 0xD0
	欧拉角整形格式，格式为int16，共三个轴，每个轴占2 个字节，顺序为Pitch/Roll/Yaw。LSB。接收到Roll, Pitch 为物理值乘以100 后得到的数值，Yaw 为乘以10 得到的数值举例：当接收到的Yaw = 100 时，表示航向角为10°

* 0xD9
	浮点格式输出的欧拉角。格式为float，共3 个值(Pitch/Roll/Yaw)，每个值占4 字节(float 型单精度
  浮点数)，LSB。

* 0XD1
	四元数，格式为float，共4个值，顺序为:W X Y Z.。每个值占4 字节(float)，整个四元数为4个float，共16字节，LSB。


* 0XF0
	气压。格式为float。(只针对有气压传感器的产品)

* 0x71
	节点四元数集合. 所有节点的四元数， 每个节点16字节，从0到最后一个节点顺序排列。每个节点 4个浮点数，分别为W X Y Z, 每个数用float 型表示，每个float 4字节。float为LSB
	
* 0x72
	)节点欧拉集合. 所有节点的欧拉角， 每个节点6字节，从0到最后一个节点顺序排列。每个节点欧拉为角整形格式，格式为int16，共三个轴，每个轴占2 个字节，顺序为Pitch/Roll/Yaw。LSB。接收到Roll, Pitch 为物理值乘以100 后得到的数值，Yaw 为乘以10 得到的数值举例：当接收到的Yaw = 100 时，表示航向角为10°
	
* 0x75
	节点加速度集合. 每个节点6字节，从0到最后一个节点顺序排列。每个节点3个int16_t 型数据。分别为X Y Z的加速度。每个int16_t 占2字节， LSB
	
* 0x78
	节点角速度集合. 每个节点6字节，从0到最后一个节点顺序排列。每个节点3个int16_t 型数据。分别为X Y Z的角速度。每个int16_t 占2字节， LSB
	
* 0x61

  数据帧拓展信息标识，共3个字节:

  | 数据帧拓展信息字节偏移 | 值   | 说明                     |
  | ---------------------- | ---- | ------------------------ |
  | 0                      | -    | 保留                     |
  | 1                      | GWID | 接收机GWID               |
  | 2                      | CNT  | 此帧包含无线节点数: 1-16 |
  



### 出厂默认寄存器

出厂默认一帧中携带寄存器数据定义如下：

HI226/HI229/HI221节点:

| 顺序 | 数据包 | 说明             |
| ---- | ------ | ---------------- |
| 1    | 0x90   | 用户ID           |
| 2    | 0xA0   | 加速度           |
| 3    | 0xB0   | 角速度           |
| 4    | 0xC0   | 磁场强度         |
| 5    | 0xD0   | 欧拉角(整形输出) |
| 6    | 0xF0   | 气压             |

HI221接收机:

| 顺序 | 寄存器 | 说明   |
| ---- | ------ | ------ |
| 1    | 0x71   | 四元数 |
| 2    | 0x75   | 加速度 |



### 数据帧结构示例

假设输出的数据帧带有 `A0,B0,D0` 寄存器，使用串口助手采样一帧数据如下所示:

`5A` `A5` `15` `00` `A9` `8B` `A0` `EA` `FF` `D0` `03` `45` `FF` `B0` `00` `00` `00` `00` `00` `00` `D0` `87` `00` `6F` `27`  `F5` `FF` 

其中：

`5A` `A5`帧头

`15` `00`帧数据域长度：`(0x00<<8) + 0x15 = 21`

`A9` `8B`帧CRC校验值: `(0x8B<<8) + 0xA9 = 0x8BA9`

`A0` `EA` `FF` `D0` `03` `45` `FF` 加速度数据包, `A0`为加速度寄存器地址， 三轴加速度为： 

​	AccX = (int16_t)((0xFF<<8)+ 0xEA) = -22
​	
​	AccY = (int16_t)((0x03<<8)+ 0xD0) = 976
​	
​	AccZ = (int16_t)((0xFF<<8)+ 0x45) = -187

`B0` `00` `00` `00` `00` `00` `00` 角速度数据包, `B0`为角速度寄存器地址， 三轴角速度全为0

`D0` `87` `00` `6F` `27` `F5` `FF` 欧拉角数据包, `D0`为欧拉角寄存器地址

​	Pitch= (int16_t)((0x00<<8)+ 0x87) / 100 = 1.35° 

​    Roll= (int16_t)((0x27<<8)+ 0x6F) / 100 = 100.95°

​    Yaw = (int16_t)((0xFF<<8)+ 0xF5) / 10 = -1.1°


计算CRC校验值：

记上面接收到的一帧数据存为C语言uint8_t 数组 buf:

```
    uint16_t payload_len;
    uint16_t crc;
    
    crc = 0;
    payload_len = buf[2] + (buf[3] << 8);
    
    /* calulate 5A A5 and LEN filed crc */
    crc16_update(&crc, buf, 4);
    
    /* calulate payload crc */
    crc16_update(&crc, buf + 6, payload_len);
```

​    最后计算得 CRC值为 0x8BA9, 与帧携带CRC值相同，帧校验正确。