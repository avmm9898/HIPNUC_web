<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link href=http://www.hipnuc.com/index_cn.html/um_common_ch/serial_protocol/ rel=canonical><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.2"><title>Serial protocol - HiPNUC 文件中心</title><link rel=stylesheet href=../../assets/stylesheets/application.adb8469c.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content><script src=../../assets/javascripts/modernizr.86422ebf.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=black data-md-color-accent=black> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#_1 tabindex=0 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=http://www.hipnuc.com/index_cn.html title="HiPNUC 文件中心" aria-label="HiPNUC 文件中心" class="md-header-nav__button md-logo"> <i class=md-icon>home</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> HiPNUC 文件中心 </span> <span class=md-header-nav__topic> Serial protocol </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input aria-label=search name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=http://www.hipnuc.com/index_cn.html title="HiPNUC 文件中心" class="md-nav__button md-logo"> <i class=md-icon>home</i> </a> HiPNUC 文件中心 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> 文档中心 </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-1> 文档中心 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=文档中心 class=md-nav__link> 文档中心 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> 产品手册 </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> 产品手册 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../hi229/hi229um_cn/ title=HI226/HI229 class=md-nav__link> HI226/HI229 </a> </li> <li class=md-nav__item> <a href=../../hi221/hi221um_cn/ title=HI221 class=md-nav__link> HI221 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 串口通讯协议 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 数据包格式 </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 出厂默认寄存器 </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 数据帧结构示例 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>Serial protocol</h1> <h2 id=_1>串口通讯协议</h2> <h3 id=_2>数据包格式</h3> <p>模块上电后，模块默认按100Hz (出厂默认输出速率) 输出数据包，数据包格式如下：</p> <p><img alt src=../common_figures/seral_protocol.png></p> <p>其中：</p> <table> <thead> <tr> <th>域</th> <th>值</th> <th>长度(字节)</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>PRE</td> <td>0x5A</td> <td>1</td> <td>固定为0x5A</td> </tr> <tr> <td>TYPE</td> <td>0xA5</td> <td>1</td> <td>固定为0xA5 代表数据帧</td> </tr> <tr> <td>LEN</td> <td>1-65535</td> <td>2</td> <td>帧中数据域的长度。LSB(低字节在前)，长度表示数据域的长度，不包含<code>PRE</code>,<code>TYPE</code>,<code>LEN</code>,<code>CRC</code> 字段。</td> </tr> <tr> <td>CRC</td> <td>-</td> <td>2</td> <td>除CRC 本身外其余所有帧数据的16 位CRC 校验和。LSB(低字节在前)</td> </tr> <tr> <td>PAYLOAD</td> <td>-</td> <td>1-256</td> <td>一帧携带的数据</td> </tr> </tbody> </table> <p>CRC实现函数：</p> <div class=highlight><pre><span></span><code>/*
    currectCrc: previous crc value, set 0 if it&#39;s first section
    src: source stream data
    lengthInBytes: length
*/
static void crc16_update(uint16_t *currectCrc, const uint8_t *src, uint32_t lengthInBytes)
{
    uint32_t crc = *currectCrc;
    uint32_t j;
    for (j=0; j &lt; lengthInBytes; ++j)
    {
        uint32_t i;
        uint32_t byte = src[j];
        crc ^= byte &lt;&lt; 8;
        for (i = 0; i &lt; 8; ++i)
        {
            uint32_t temp = crc &lt;&lt; 1;
            if (crc &amp; 0x8000)
            {
                temp ^= 0x1021;
            }
            crc = temp;
        }
    } 
    *currectCrc = crc;
}
</code></pre></div> <ul> <li>PAYLOAD(数据域): PAYLOAD 由若干个**寄存器数据**组成。每个寄存器数据包含：寄存器地址(REG_ADDR)和寄存器数据(DATA) 两部分。寄存器地址决定了数据的类型及长 度，DATA 为寄存器数据内容。模块支持的寄存器如下:</li> </ul> <table> <thead> <tr> <th>寄存器地址(REG_ADDR)</th> <th>寄存器长度(DATA长度, 单位字节)</th> <th>名称</th> <th>单位</th> <th>支持该数据包的产品</th> </tr> </thead> <tbody> <tr> <td>0x90</td> <td>1</td> <td>用户ID</td> <td>无</td> <td>HI22X</td> </tr> <tr> <td>0xA0</td> <td>6</td> <td>加速度</td> <td>0.001G[^G]</td> <td>HI22X</td> </tr> <tr> <td>0xA5</td> <td>6</td> <td>线性加速度</td> <td>0.001G</td> <td>HI22X</td> </tr> <tr> <td>0xB0</td> <td>6</td> <td>角速度</td> <td>0.1°/s</td> <td>HI22X</td> </tr> <tr> <td>0xC0</td> <td>6</td> <td>磁场强度</td> <td>0.001Gauss</td> <td>HI22X</td> </tr> <tr> <td>0xD0</td> <td>6</td> <td>欧拉角 (整形输出)</td> <td>度</td> <td>HI22X</td> </tr> <tr> <td>0xD9</td> <td>12</td> <td>欧拉角(浮点输出)</td> <td>度</td> <td>HI22X</td> </tr> <tr> <td>0xD1</td> <td>16</td> <td>四元数</td> <td>N/A</td> <td>HI22X</td> </tr> <tr> <td>0xF0</td> <td>4</td> <td>气压</td> <td>Pa</td> <td>N/A</td> </tr> <tr> <td>0x71</td> <td>128-256字节可变</td> <td>无线节点四元数集合</td> <td>无</td> <td>HI221GW(接收机)</td> </tr> <tr> <td>0x72</td> <td>48-96字节可变</td> <td>无线节点欧拉角集合</td> <td>同0xD0</td> <td>HI221GW(接收机)</td> </tr> <tr> <td>0x75</td> <td>48-96字节可变</td> <td>无线节点加速度集合</td> <td>同0xA0</td> <td>HI221GW(接收机)</td> </tr> <tr> <td>0x78</td> <td>48-96字节可变</td> <td>无线节点角速度集合</td> <td>同0xB0</td> <td>HI221GW(接收机)</td> </tr> <tr> <td>0x61</td> <td>3</td> <td>无线数据帧拓展标识</td> <td>N/A</td> <td>HI221GW(接收机)</td> </tr> </tbody> </table> <ul> <li> <p>0x90 用户ID</p> </li> <li> <p>0xA0 加速度，格式为int16，共三个轴，每个轴占2 个字节，X、Y、Z 三轴共6 个字节，LSB。传感器输出的原始加速度</p> </li> <li> <p>0xA5 性加速度，格式为int16，共三个轴，每个轴占2 个字节，X、Y、Z 三轴共6 个字节，LSB。地理坐标系下去除重力分量的加速度值</p> </li> <li> <p>0xB0 角速度，格式为int16，共三个轴，每个轴占2 个字节，X、Y、Z 三轴共6 个字节，LSB。传感器输出的角速度</p> </li> <li> <p>0xC0 磁场强度，格式为int16，共三个轴，每个轴占2 个字节，X、Y、Z 三轴共6 个字节，LSB。传感器输出的磁场强度</p> </li> <li> <p>0xD0 欧拉角整形格式，格式为int16，共三个轴，每个轴占2 个字节，顺序为Pitch/Roll/Yaw。LSB。接收到Roll, Pitch 为物理值乘以100 后得到的数值，Yaw 为乘以10 得到的数值举例：当接收到的Yaw = 100 时，表示航向角为10°</p> </li> <li> <p>0xD9 浮点格式输出的欧拉角。格式为float，共3 个值(Pitch/Roll/Yaw)，每个值占4 字节(float 型单精度 浮点数)，LSB。</p> </li> <li> <p>0XD1 四元数，格式为float，共4个值，顺序为:W X Y Z.。每个值占4 字节(float)，整个四元数为4个float，共16字节，LSB。</p> </li> <li> <p>0XF0 气压。格式为float。(只针对有气压传感器的产品)</p> </li> <li> <p>0x71 节点四元数集合. 所有节点的四元数， 每个节点16字节，从0到最后一个节点顺序排列。每个节点 4个浮点数，分别为W X Y Z, 每个数用float 型表示，每个float 4字节。float为LSB</p> </li> <li> <p>0x72 )节点欧拉集合. 所有节点的欧拉角， 每个节点6字节，从0到最后一个节点顺序排列。每个节点欧拉为角整形格式，格式为int16，共三个轴，每个轴占2 个字节，顺序为Pitch/Roll/Yaw。LSB。接收到Roll, Pitch 为物理值乘以100 后得到的数值，Yaw 为乘以10 得到的数值举例：当接收到的Yaw = 100 时，表示航向角为10°</p> </li> <li> <p>0x75 节点加速度集合. 每个节点6字节，从0到最后一个节点顺序排列。每个节点3个int16_t 型数据。分别为X Y Z的加速度。每个int16_t 占2字节， LSB</p> </li> <li> <p>0x78 节点角速度集合. 每个节点6字节，从0到最后一个节点顺序排列。每个节点3个int16_t 型数据。分别为X Y Z的角速度。每个int16_t 占2字节， LSB</p> </li> <li> <p>0x61</p> </li> </ul> <p>数据帧拓展信息标识，共3个字节:</p> <table> <thead> <tr> <th>数据帧拓展信息字节偏移</th> <th>值</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>0</td> <td>-</td> <td>保留</td> </tr> <tr> <td>1</td> <td>GWID</td> <td>接收机GWID</td> </tr> <tr> <td>2</td> <td>CNT</td> <td>此帧包含无线节点数: 1-16</td> </tr> </tbody> </table> <h3 id=_3>出厂默认寄存器</h3> <p>出厂默认一帧中携带寄存器数据定义如下：</p> <p>HI226/HI229/HI221节点:</p> <table> <thead> <tr> <th>顺序</th> <th>数据包</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>0x90</td> <td>用户ID</td> </tr> <tr> <td>2</td> <td>0xA0</td> <td>加速度</td> </tr> <tr> <td>3</td> <td>0xB0</td> <td>角速度</td> </tr> <tr> <td>4</td> <td>0xC0</td> <td>磁场强度</td> </tr> <tr> <td>5</td> <td>0xD0</td> <td>欧拉角(整形输出)</td> </tr> <tr> <td>6</td> <td>0xF0</td> <td>气压</td> </tr> </tbody> </table> <p>HI221接收机:</p> <table> <thead> <tr> <th>顺序</th> <th>寄存器</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>0x71</td> <td>四元数</td> </tr> <tr> <td>2</td> <td>0x75</td> <td>加速度</td> </tr> </tbody> </table> <h3 id=_4>数据帧结构示例</h3> <p>假设输出的数据帧带有 <code>A0,B0,D0</code> 寄存器，使用串口助手采样一帧数据如下所示:</p> <p><code>5A</code> <code>A5</code> <code>15</code> <code>00</code> <code>A9</code> <code>8B</code> <code>A0</code> <code>EA</code> <code>FF</code> <code>D0</code> <code>03</code> <code>45</code> <code>FF</code> <code>B0</code> <code>00</code> <code>00</code> <code>00</code> <code>00</code> <code>00</code> <code>00</code> <code>D0</code> <code>87</code> <code>00</code> <code>6F</code> <code>27</code> <code>F5</code> <code>FF</code> </p> <p>其中：</p> <p><code>5A</code> <code>A5</code>帧头</p> <p><code>15</code> <code>00</code>帧数据域长度：<code>(0x00&lt;&lt;8) + 0x15 = 21</code></p> <p><code>A9</code> <code>8B</code>帧CRC校验值: <code>(0x8B&lt;&lt;8) + 0xA9 = 0x8BA9</code></p> <p><code>A0</code> <code>EA</code> <code>FF</code> <code>D0</code> <code>03</code> <code>45</code> <code>FF</code> 加速度数据包, <code>A0</code>为加速度寄存器地址， 三轴加速度为： </p> <p>​ AccX = (int16_t)((0xFF&lt;&lt;8)+ 0xEA) = -22 ​ <br> ​ AccY = (int16_t)((0x03&lt;&lt;8)+ 0xD0) = 976 ​ <br> ​ AccZ = (int16_t)((0xFF&lt;&lt;8)+ 0x45) = -187</p> <p><code>B0</code> <code>00</code> <code>00</code> <code>00</code> <code>00</code> <code>00</code> <code>00</code> 角速度数据包, <code>B0</code>为角速度寄存器地址， 三轴角速度全为0</p> <p><code>D0</code> <code>87</code> <code>00</code> <code>6F</code> <code>27</code> <code>F5</code> <code>FF</code> 欧拉角数据包, <code>D0</code>为欧拉角寄存器地址</p> <p>​ Pitch= (int16_t)((0x00&lt;&lt;8)+ 0x87) / 100 = 1.35° </p> <p>​ Roll= (int16_t)((0x27&lt;&lt;8)+ 0x6F) / 100 = 100.95°</p> <p>​ Yaw = (int16_t)((0xFF&lt;&lt;8)+ 0xF5) / 10 = -1.1°</p> <p>计算CRC校验值：</p> <p>记上面接收到的一帧数据存为C语言uint8_t 数组 buf:</p> <div class=highlight><pre><span></span><code>    uint16_t payload_len;
    uint16_t crc;

    crc = 0;
    payload_len = buf[2] + (buf[3] &lt;&lt; 8);

    /* calulate 5A A5 and LEN filed crc */
    crc16_update(&amp;crc, buf, 4);

    /* calulate payload crc */
    crc16_update(&amp;crc, buf + 6, payload_len);
</code></pre></div> <p>​ 最后计算得 CRC值为 0x8BA9, 与帧携带CRC值相同，帧校验正确。</p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2016 - 2020 HiPNUC </div> powered by <a href=https://www.mkdocs.org target=_blank rel=noopener>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs</a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.c33a9706.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> <script src=../../extra.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>