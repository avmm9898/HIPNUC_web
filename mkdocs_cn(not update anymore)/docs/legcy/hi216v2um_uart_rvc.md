---
typora-root-url: ..\figures
---

# HI216(V2)用户手册  (UART-RVC输出协议)
<p style="text-align: right;">VRU/IMU姿态测量模块, Rev A6












<img src="hi216v2/HI216V2.png" width="400px" />

<div style="page-break-after: always;"></div>

[TOC]

<div style="page-break-after: always;"></div>

## 简介

HI216(V2)是超核电子推出的一款低成本、高性能、小体积、低延时的惯性测量单元（IMU），本产品集成了三轴加速度计、三轴陀螺仪以及一款低功耗微处理器。可输出经过传感器融合算法计算得到的基于当地地理坐标的三维方位数据，包含横滚角、俯仰角和相对的航向角。同时也可以输出原始的传感器数据。

典型应用：

- 为室内机器人/送餐机器人/扫地机器人提供精确的3D姿态信息
- 云台姿态检测，大型设备姿态稳定系统
- 配合双目或单目相机组成视觉惯性里程计


## 特性

### 板载传感器
- 三轴陀螺仪, 最大量程: ±2000°/s
- 三轴加速度计, 最大量程:±8g
### 数据处理 
- 加速度计出厂前经过校准
- 数据融合算法计算并输出地理坐标系下的旋转四元数及欧拉角
### 通讯接口及供电
- 串口(兼容TTL 可直接与5V 或3.3V 串口设备连接)
- 供电电压：3.3 (+/- 100 mV)
- 最大峰值功耗：20mA
### 其他
- PC端上位机程序，提供实时数据显示，波形，校准及excel 数据记录功能
- 多项模块参数用户可配置

## 硬件及尺寸

### 硬件参数

| 参数           | 描述                        |
| -------------- | --------------------------- |
| 输出数据接口   | UART(TTL 1.8V - 3.3V)       |
| 工作电压       | 3.3V (± 100mV)              |
| 功耗           | 66mW @3.3V                  |
| 温度范围       | -20℃  - 85 ℃                |
| 最大线性加速度 | 0 - 115 $m/s^2$             |
| 尺寸           | 12 x 12 x 2.6mm (W x L x H) |
| 板载传感器     | 三轴加速度计 三轴陀螺仪     |

### 尺寸

![002](hi216v2/HI216MV2尺寸.jpg)

| 符号 | 最小值 | 典型值 | 最大值 | 单位 |
| ---- | ------ | ------ | ------ | ---- |
| A1   | -      | 11     | -      | mm   |
| B    | -      | 11     | -      | mm   |
| D    | -      | 12     | -      | mm   |
| E    | -      | 12     | -      | mm   |
| H    | 2.5    | 2.6    | 2.7    | mm   |
| a    | -      | 1.5    | -      | mm   |
| b    | -      | 0.9    | -      | mm   |
| c    | -      | 1      | -      | mm   |
| e    | -      | 1.27   | -      | mm   |
| f    | -      | 1      | -      | mm   |

### 引脚定义
<img src="hi216v2/HI216V2引脚定义.jpg" width="800px" />

| 引脚号 | 名称   | 说明                                  |
| ------ | ------ | ------------------------------------- |
| 5      | N/C | 保留                                  |
| 6      | VCC    | 电源 3.3V                             |
| 7      | N/C | 保留                                  |
| 8      | RXD    | 模块串口接收 UART RXD(接 MCU 的 TXD)  |
| 9      | TXD    | 模块串口发送 UART TXD (接 MCU 的 RXD) |
| 10     | N/C    | 保留                                  |
| 11     | N/C    | 保留                                  |
| 19     | GND    | GND                                   |
| 20     | RST    | 复位,内部上拉。>10uS 低电平复位模块。无需要外接阻容，建议接到MCU的GPIO引脚以实现软件复位 |
| 21     | SYNC_OUT | 数据输出同步:  数据输出时，此引脚为高电平，发送空闲时，为低电平 |
| 22     | SYNC_IN | 数据输入同步:  内部下拉。当模块检测到上升沿时, 输出一帧数据**(HI216 不支持)** |
| 23     | N/C    | 保留                                  |
| 24     | GND    | GND                                   |
| 25     | N/C    | 保留                                  |

[^1]: 通用输入输出口，不使用可悬空

### 安装建议

由于传感器制造工艺的原因，XY 和 Z 轴性能有略微差异，安装时建议将模块 Z 轴与重力方向保持平行(既水平安装)，以获得最好的性能。本产品系列采用 JEDEC PLCC28 封装，与 PLCC28 的标准插座兼容。

### 焊接建议

1. 用印刷刮板在网板上印刷锡膏，使锡膏通过网板开口漏印到PCB上。为保证回流焊接质量，推荐焊盘部分对应的钢网厚度为0.18mm。

2. 本产品推荐回流焊的温度为235℃-245℃，峰值温度不超过260℃。为避免模组反复受热而损坏，建议客户在PCB板第一面完成回流焊后再贴模组。

3. 组装好的PCB不得使用超声波清洁仪进行清洁。

4. 推荐的炉温曲线图如下：

   <img src="/焊接曲线.png" width="400px" />

5. 非标准的实验室用小回流焊机回流焊接时会导致热风风向不均匀，造成焊接后模型性能有所下降，平均性能下降一般在0 - 5%以内。

### 参考系定义

本产品采用右手(RH, Right-Hand)坐标系。输出的四元数及欧拉角为  惯性坐标系(世界坐标系) -> 传感器坐标系的旋转。其中欧拉角旋转顺序为 ZYX(也称 321)旋转顺序，欧拉角具体定义如下：

- 绕 Z 轴方向旋转: 航向角\Yaw\phi($\psi$) 范围: -180° - 180°
- 绕 Y 轴方向旋转: 俯仰角\Pitch\theta($\theta​$) 范围: -90°-90°
- 绕 X 轴方向旋转:横滚角\Roll\psi(  $\phi$)范围: -180°-180°

本产品使用 右手系 笛卡儿 北西天(NWU) 坐标系统，即视为模块的地理坐标系(世界坐标系)定义如下：

- X 轴正方向指向北
- Y 轴正方向指向西
- Z 轴正方向指向天

当采用 NWU 系时，如果将模块视为飞行器的话。X 轴应视为机头方向。当传感器系与惯性系重合时，欧拉角的理想输出为:Pitch = 0°, Roll = 0°, Yaw = 0°

**注意**，以上定义中只在绝对航向角模式下才有意义，在没有地磁场校准的在相对航向角模式下(如HI216 或者HI219工作在6轴模式时)，航向角在模块启动后既输出为 0°，与地理方位无任何关系。换句话说：俯仰角，横滚角因为有地球重力场校准，可以获得绝对角度，并且没有漂移。而与地球重力场正交方向的角度(航向角)没有恒定向量场参考，所以长时间工作会产生漂移。这种模式下也称作 VRU模块(垂直测量参考单元)

## 性能指标

### 姿态角输出精度

| 姿态角               | 典型值               | 最大值               |
| -------------------- | -------------------- | -------------------- |
| 横滚角\俯仰角 - 静态 | 0.2°                 | 0.4°                 |
| 横滚角\俯仰角 - 动态 | 0.5°                 | 2.0°                 |
| 航向角               | 相对航向角无参考标准 | 相对航向角无参考标准 |

### 陀螺仪

| 参数     | 值                   |
| -------- | -------------------- |
| 测量范围 | ±2000 deg/s          |
| 非线性度 | ±0.1% (25°最佳)      |
| 噪声密度 | 0.08°/s/$$ \sqrt{Hz}$$ |
| 采样率   | 400Hz       |


### 加速度计

| 参数         | 值                      |
| ------------ | ----------------------- |
| 测量范围     | ±8G(1G = 1x 重力加速度) |
| 非线性度     | ±0.1% (25°最佳)         |
| 最大零点偏移 | 30mG(校准后)            |
| 噪声密度     | 250  uG\sqrt{Hz}        |
| 采样率       | 400Hz                   |


### 模块数据接口参数

| 参数           | 值                     |
| -------------- | ---------------------- |
| 串口输出波特率 | 9600/115200/460800可选 |
| 帧输出速率     | 1 - 200Hz              |

## 通讯接口

### 连接主机

HI216目前支持串口连接,只需要连接UART_TX, UART_RX, GND到主控制器上即可。

<img src="/应用框图.png" width="400px" />

Note：

* UART连接是交叉连接，即： 主机TX连接HI216 RX,  主机RX连接HI216 TX
* HI2XX的复位信号(RST) 可以悬空，但建议连接到主控制器的一个GPIO引脚上，在主控制器完全启动后，利用该GPIO对模块做一次外部复位。

### 数据包格式

模块资料包中提供了C 和C#的数据解析函数以供参考。模块上电后，模块默认按100Hz (出厂默认输
出速率) 输出数据包，数据包格式如下：

`HEADER` + `INDEX`+ `YAW`+ `PITCH` + `ROLL` + `XAcc` + `YAcc` + `ZAcc` + `REV` + `CSUM`

| 数据域 | 长度（byte） | 说明                                                         |
| ------ | ------------ | ------------------------------------------------------------ |
| HEADER | 2            | Each report is prefixed with a 0xAAAA header                 |
| INDEX  | 1            | A monotonically increasing 8-bit count is provided (0-255) per report |
| YAW    | 2            | The yaw is a measure of the rotation around the Z-axis since reset. The yaw has a range of +/- 180˚ and is provided in 0.01˚ increments, i.e. a report of 8734 is equivalent to 87.34˚ |
| PITCH  | 2            | Pitch: The pitch is a measure of the rotation around the Y-axis. The pitch has a range of +/- 90˚ and is provided in 0.01˚ increments, i.e. a report of 1072 is equivalent to 10.72˚ |
| ROLL   | 2            | Roll: The roll is a measure of the rotation around the X-axis. The roll has a range of +/- 180˚ and is provided in 0.01˚ increments, i.e. a report of 1072 is equivalent to 10.72˚. |
| XAcc   | 2            | X-axis acceleration: The acceleration along the X-axis, presented in mg |
| YAcc   | 2            | Y-axis acceleration: The acceleration along the Y-axis, presented in mg |
| YAcc   | 2            | Z-axis acceleration: The acceleration along the Z-axis, presented in mg |
| REV    | 3            | The message is terminated with three reserved bytes, currently set to zero |
| CSUM   | 1            | The Index, yaw, pitch, roll, acceleration and reserved data bytes are added to produce the<br/>checksum. |

### AT指令

本模块采用AT 指令集配置/查看模块参数。AT 指令总以ASCII 码”AT” 开头，后面跟控制字符，最
后以回车换行“\r\n”结束。可使用串口调试助手进行测试：

<img src="/005.png" width="600px" />

AT指令列表如下：

| 指令    | 是否掉电保存 | 默认值 | 说明               |
| ------- | ------------ | ------ | ------------------ |
| AT+INFO | N            | N/A    | 打印模块基本信息   |
| AT+ODR  | Y            | 100    | 设置模块输出帧频率 |
| AT+EOUT | N            | 1      | 数据输出开关       |
| AT+RST  | N            | N/A    | 复位模块           |

- `AT+INFO` 打印模块信息，包含版本号，产品名称等

- `AT+ODR` 设置数据输出速率，如 `AT+ODR=50` 目前支持的输出速率为: 25,50,100,200

- `AT+RST` 复位模块

- `AT+EOUT` 开启/关闭数据输出 如开启输出`AT+EOUT=1`, 关闭数据输出`AT+EOUT=0`

- `AT+TRG` 触发模块输出一帧数据，可以配合AT+ODR=0来实现单次触发输出。


## 融合及校准算法
### 校准

每一个HI216模块都经过出厂前的 加速度和陀螺仪的刻度因子以及三轴非正交性以及零偏校准，这些校准参数会记录到模块上CPU的内部非失存储器上。一般情况下，用户无需再对加速度和陀螺仪进行校准。陀螺仪自动校准需要在上电后静止模块1S 左右，以获得最好的校准效果。如果上电静置短于规定时间，则模块陀螺仪零偏校准效果会下降。

### 融合算法输出

模块板载处理器将三轴陀螺仪、三轴加速度计数据进行融合，该算法包含稳健的姿态解算、误差动态估计和自主航位稳定。

## 评估板

### 评估板简介

评估板提供了快速评估本产品的方法。评估板板子资源包括：

- MicroUSB 接口，提供USB 转串口功能和供电功能

- 板载CP2104 USB-UART 芯片，并且可输出3.3V 100mA 给姿态模块供电

  <img src="hi216v2/HI216DKV2.png" width="300px" />

### 使用评估板

安装资料包中的CP2104 USB-UART 驱动程序, 将MicroUSB 线连接电脑和模块，打开资料包中的Uranus 上位机，连接串口，默认状态下，模块会以115200-N-8-N-1 输出出厂默认的数据包。

### 从评估板上取下产品

模块默认被嵌入评估板的PLCC-28 插槽中，如需取出模块，请按如下步骤操作：
- 断电，准备好细螺丝刀或镊子
- 从PLCC 插座或者背面圆形空洞内将模块撬出或顶出。

### 其他注意事项

- 评估板的主要作用仅仅是快速评估模块性能，USB 接口本身适合于工业级或者高运动场合适合的连接，如果您的应用为高运动环境(动作捕捉等)，则不建议在您的产品中直接使用评估板。
- 当使用评估板时，模块的串口与USB-UART 芯片连接，因为UART 只能一对一通讯，不能一个输入对多个输出，所以当使用评估板时，不能再将模块的TX,RX 引脚接到其他串口设备上。否则会造成物理损坏

## 固件升级与恢复出厂设置

### 固件升级

本产品支持在线升级固件，请关注超核电子官网www.hipnuc.com 来获取最新固件版本
固件升级步骤:
- 从www.hipnuc.com 获取最新的固件程序。拓展名为xxx.hex
- 连接模块，打开上位机，将模块和上位机波特率设置为115200.切换到固件升级窗口
- 点击连接按钮，如出现模块连接信息。则说明升级系统准备就绪，点击文件选择器(…)选择拓
展名为xxx.hex 的固件，然后点击开始编程。下载完成后会提示编程完成，此时关闭串口，
重新上电，模块升级完成。
- 注意，升级模块固件后，用户配置数据和校准数据会丢失。

<img src="/固件升级.png" width="600px"/>

### 恢复出厂设置

当模块被设置成错误的波特率时，会导致输出波特率不正确造成不能再接受新的AT 指令（波特率不能与上位机匹配导致）。可以通过以下方法来强制恢复模块所有配置参数为为出厂默认参数。恢复出厂设置会清除所有用户配置数据。

- 模块断电，并且短接GPIO21 与GND
- 重新上电模块， 此时出厂参数已经被恢复
- 断开GPIO21与GND

## 附录A - 四元数-欧拉角转换

旋转矩阵，四元数和欧拉角是表示旋转的三种常用方式，其中另外两种表示形式转换为欧拉角时，必须先指定欧拉角旋转顺序。本产品使用"321"旋转顺序：

转换公式为：

<img src="/quat2eul.png" width="300px"/>

四元数转换欧拉角的C函数如下： 

```

/* eular angle: e[0]:Roll e[1]:Pitch e[2]:Yaw */
void quat2eul(float32_t *q, float32_t *e, const char *seq)
{
    float xz = q[1] * q[3];
    float wy = q[0] * q[2];
    float yz = q[2] * q[3];
    float wx = q[0] * q[1];
    float wz = q[0] * q[3];
    float xy = q[1] * q[2];
    float ww = q[0] * q[0];
    float xx = q[1] * q[1];
    float yy = q[2] * q[2];
    float zz = q[3] * q[3];
    
    if(!strcmp(seq, "ZYX") || !strcmp(seq, "321"))
    {
        e[0] = (float)atan2f(2.0F*(yz + wx), ww - xx - yy + zz); 
        e[1] = (float)asinf(2*(wy -xz));
        e[2] = (float)atan2f(2.0F*(wz + xy), ww + xx  - yy - zz);
    }
}

```

调用

```
quat2eul(q, eul, "321");
```



##  版本历史

| 版本 | 日期     | 作者   | 描述                                       |
| ---- | -------- | ------ | ------------------------------------------ |
| Beta | 20171228 | Yandld | 重新命名为HI216UM，增加了一些细节描述      |
| A    | 20171230 | Yandld | 改为md排版                                 |
| A1   | 20180301 | Yandld | 微调内容                                   |
| A2   | 20180615 | Yandld | 修改默认输出协议内容，去掉了一些AT指令     |
| A3   | 20180705 | Yandld | 修改ACC,GYR参数，增加SYNC OUT SYNC IN 功能 |
| A4   | 20181101 | Yandld | 删除同步输入内容(trigger)                  |
| A5   | 20181119 | Yandld | 修改部分错误参数                           |
| A6   | 20180109 | Yandld | 修改为HI216V2                              |